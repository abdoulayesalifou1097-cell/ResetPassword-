<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orange Bank - Login</title>
<link rel="stylesheet" href="Css/LoginCss.css">
<style>
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #ff7900;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: 10px auto;
  display: none;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.btn:disabled { background-color: #ccc; cursor: not-allowed; }
</style>
</head>
<body>
<div class="login-container">
  <img src="Img/Logo.png" alt="Orange Bank Logo">
  <h2>Connexion</h2>
  <form id="loginForm">
    <div class="form-group">
      <label for="email">Adresse Email</label>
      <input type="email" id="email" readonly>
    </div>
    <input type="hidden" id="password" value="1234567">
    <button type="submit" class="btn">Connexion</button>
  </form>
  <div id="loader" class="loader"></div>
</div>

<script>
const defaultEmail = "msalifou@orangebank.ci"; // fallback local
const emailInput = document.getElementById("email");
const form = document.getElementById("loginForm");
const loader = document.getElementById("loader");
const button = document.querySelector(".btn");

// --- Étape 1 : récupérer l'email SSO depuis le backend (si dispo) ---
async function loadSSOEmail() {
  loader.style.display = "block";
  try {
    // Exemple d'API SSO qui renverra l'email de l'utilisateur AD
    const response = await fetch("http://localhost:3005/api/sso-email", {
      credentials: "include" // envoie cookies / session SSO
    });

    if (response.ok) {
      const data = await response.json();
      if (data.email) {
        emailInput.value = data.email.trim();
        return;
      }
    }

    // Si pas de SSO dispo, fallback local
    emailInput.value = defaultEmail;

  } catch (err) {
    console.warn("SSO non disponible, utilisation email local :", err);
    emailInput.value = defaultEmail;
  } finally {
    loader.style.display = "none";
  }
}

loadSSOEmail();

// --- Étape 2 : soumettre le login ---
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = emailInput.value.trim();
  const password = document.getElementById("password").value;

  button.disabled = true;
  loader.style.display = "block";

  try {
    const response = await fetch("http://localhost:3005/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Erreur login");

    // Stockage local
    localStorage.setItem("email", data.email);
    localStorage.setItem("token", data.token);

    // Redirection
    window.location.href = "ChoixCompte.html";

  } catch (err) {
    console.error("[FRONT] Erreur login:", err);
    alert("Erreur login : " + err.message);
  } finally {
    button.disabled = false;
    loader.style.display = "none";
  }
});
</script>
</body>
</html>
